---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import SearchBar from '../components/SearchBar.astro';
import Filters from '../components/Filters.astro';
import ProductCard from '../components/ProductCard.astro';
import Footer from '../components/Footer.astro';

// Use the fixed i18n utility
import { loadTranslations, getUserLanguage, SUPPORTED_LANGUAGES } from '../utils/i18n.js';

// Import product data
import productData from '../data/products.json';

const { products, categories, brands } = productData;

// Get language - simplified
const url = new URL(Astro.request.url);
const pathSegments = url.pathname.split('/').filter(Boolean);
const langFromPath = pathSegments[0] in SUPPORTED_LANGUAGES ? pathSegments[0] : null;
const currentLang = langFromPath || getUserLanguage();

// Load translations safely
const translations = loadTranslations(currentLang);

// Get URL parameters
const searchQuery = url.searchParams.get('q') || '';
const categoryFilter = url.searchParams.get('category') || '';
const priceFilter = url.searchParams.get('price') || '1000';
const sortFilter = url.searchParams.get('sort') || 'relevance';

// Filter products (same logic as before)
let filteredProducts = [...products];

if (searchQuery) {
  const query = searchQuery.toLowerCase();
  filteredProducts = filteredProducts.filter(product => 
    product.title.toLowerCase().includes(query) ||
    product.description.toLowerCase().includes(query) ||
    product.brand.toLowerCase().includes(query) ||
    product.category.toLowerCase().includes(query)
  );
}

if (categoryFilter) {
  filteredProducts = filteredProducts.filter(product => product.category === categoryFilter);
}


if (priceFilter && priceFilter !== '1000') {
  const maxPrice = parseInt(priceFilter);
  filteredProducts = filteredProducts.filter(product => {
    const minProductPrice = Math.min(...product.markets.map(m => m.price));
    return minProductPrice <= maxPrice;
  });
}

// Apply sorting
if (sortFilter === 'price-low') {
  filteredProducts.sort((a, b) => Math.min(...a.markets.map(m => m.price)) - Math.min(...b.markets.map(m => m.price)));
} else if (sortFilter === 'price-high') {
  filteredProducts.sort((a, b) => Math.min(...b.markets.map(m => m.price)) - Math.min(...a.markets.map(m => m.price)));
} else if (sortFilter === 'rating') {
  filteredProducts.sort((a, b) => b.rating - a.rating);
} else if (sortFilter === 'popular') {
  filteredProducts.sort((a, b) => b.reviewCount - a.reviewCount);
}

// Serialize for client-side
const serializedProducts = JSON.stringify(products);
---

<Layout 
  title={translations.site?.title || "PriceCompare - Find the Best Deals Online"} 
  description={translations.site?.description || "Compare prices across multiple online marketplaces to find the best deals"}
  lang={currentLang}
>
  <Header currentLang={currentLang} translations={translations} />
  
  <main class="flex-1 w-full px-3 sm:px-4 py-4 sm:py-6">
    <div class="max-w-2xl lg:max-w-6xl mx-auto">
      <!-- Search Section -->
      <section class="mb-6 sm:mb-8 px-2">
        <SearchBar initialQuery={searchQuery} translations={translations} />
      </section>
      
      <div class="flex flex-col lg:flex-row gap-4 sm:gap-6">
        <!-- Filters Sidebar -->
        <aside class="lg:w-64 flex-shrink-0 order-1 mr-10">
          <div class="max-w-md mx-auto lg:max-w-none">
            <Filters 
              categories={categories} 
              brands={brands}
              selectedCategory={categoryFilter}
              selectedSort={sortFilter}
              priceRange={{ min: 0, max: parseInt(priceFilter) }}
              translations={translations}
            />
          </div>
        </aside>
        
        <!-- Products Section -->
        <section class="flex-1 order-2 lg:order-2">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6 gap-2 px-2">
            <h2 class="text-lg sm:text-xl font-semibold text-gray-800 dark:text-gray-200 text-center sm:text-left">
              {filteredProducts.length === 1 
                ? (translations.products?.found_singular || "{count} Product Found").replace('{count}', filteredProducts.length)
                : (translations.products?.found || "{count} Products Found").replace('{count}', filteredProducts.length)
              }
              {searchQuery && ` for "${searchQuery}"`}
            </h2>
            
            <div class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 text-center sm:text-right">
              {translations.filters?.sort || "Sorted by"}: 
              <span class="font-medium ml-1">
                {sortFilter === 'relevance' ? (translations.filters?.sortOptions?.relevance || "Relevance") :
                 sortFilter === 'price-low' ? (translations.filters?.sortOptions?.["price-low"] || "Price: Low to High") :
                 sortFilter === 'price-high' ? (translations.filters?.sortOptions?.["price-high"] || "Price: High to Low") :
                 sortFilter === 'rating' ? (translations.filters?.sortOptions?.rating || "Highest Rated") : 
                 (translations.filters?.sortOptions?.popular || "Most Popular")}
              </span>
            </div>
          </div>
          
          {filteredProducts.length > 0 ? (
            <div class="grid grid-cols-1 gap-4 sm:gap-6 px-2">
              {filteredProducts.map(product => (
                <ProductCard product={product} translations={translations} />
              ))}
            </div>
          ) : (
            <div class="text-center py-8 sm:py-12 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 max-w-md mx-auto">
              <svg class="mx-auto h-10 w-10 sm:h-12 sm:w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <h3 class="mt-2 text-base sm:text-lg font-medium text-gray-900 dark:text-gray-100">
                {translations.noResults?.title || "No products found"}
              </h3>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                {translations.noResults?.description || "Try adjusting your search or filter criteria"}
              </p>
              <div class="mt-4 sm:mt-6">
                <button 
                  id="resetAllFilters" 
                  class="inline-flex items-center px-3 sm:px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                >
                  {translations.noResults?.reset || "Reset all filters"}
                </button>
              </div>
            </div>
          )}
        </section>
      </div>
    </div>
  </main>
  
  <Footer currentLang={currentLang} translations={translations} />
  
  <script>
    // Store products for client-side filtering
    const allProducts = {serializedProducts};
    
    // Simple filtering functions
    function filterProducts(query) {
      applyFilters(
        document.getElementById('categoryFilter')?.value || '',
        document.getElementById('brandFilter')?.value || '',
        document.getElementById('priceRange')?.value || 1000,
        document.getElementById('sortOptions')?.value || 'relevance'
      );
    }
    
    function applyFilters(category, brand, maxPrice, sortBy) {
      let filtered = [...allProducts];
      const searchQuery = document.getElementById('searchInput')?.value.trim() || '';
      
      // Apply filters (same logic as server-side)
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filtered = filtered.filter(product => 
          product.title.toLowerCase().includes(query) ||
          product.description.toLowerCase().includes(query) ||
          product.brand.toLowerCase().includes(query) ||
          product.category.toLowerCase().includes(query)
        );
      }
      
      if (category) filtered = filtered.filter(p => p.category === category);
      if (brand) filtered = filtered.filter(p => p.brand === brand);
      if (maxPrice !== '1000') {
        filtered = filtered.filter(p => Math.min(...p.markets.map(m => m.price)) <= parseInt(maxPrice));
      }
      
      // Apply sorting
      if (sortBy === 'price-low') filtered.sort((a, b) => Math.min(...a.markets.map(m => m.price)) - Math.min(...b.markets.map(m => m.price)));
      else if (sortBy === 'price-high') filtered.sort((a, b) => Math.min(...b.markets.map(m => m.price)) - Math.min(...a.markets.map(m => m.price)));
      else if (sortBy === 'rating') filtered.sort((a, b) => b.rating - a.rating);
      else if (sortBy === 'popular') filtered.sort((a, b) => b.reviewCount - a.reviewCount);
      
      displayFilteredProducts(filtered);
      updateURL(searchQuery, category, brand, maxPrice, sortBy);
    }
    
    function displayFilteredProducts(filtered) {
      const container = document.querySelector('.min-w-0 .grid, .min-w-0 .text-center');
      const countEl = document.querySelector('.min-w-0 h2');
      const searchQuery = document.getElementById('searchInput')?.value.trim() || '';
      
      if (countEl) {
        const countText = filtered.length === 1 
          ? `1 ${translations?.products?.found_singular?.replace('{count}', '1') || 'Product Found'}`
          : `${filtered.length} ${translations?.products?.found?.replace('{count}', filtered.length) || 'Products Found'}`;
        countEl.innerHTML = `${countText}${searchQuery ? ` for "${searchQuery}"` : ''}`;
      }
      
      if (filtered.length > 0) {
        // Simplified product display - you can expand this as needed
        container.innerHTML = '<div class="grid grid-cols-1 gap-6">Products found: ' + filtered.length + '</div>';
      } else {
        container.innerHTML = `
          <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-gray-100">No products found</h3>
            <p class="mt-1 text-gray-500 dark:text-gray-400">Try adjusting your search or filter criteria</p>
            <div class="mt-6">
              <button id="resetAllFilters" class="px-4 py-2 bg-primary-600 text-white rounded-md">Reset all filters</button>
            </div>
          </div>
        `;
        document.getElementById('resetAllFilters').addEventListener('click', resetAllFilters);
      }
    }
    
    function updateURL(search, category, brand, price, sort) {
      const params = new URLSearchParams();
      if (search) params.set('q', search);
      if (category) params.set('category', category);
      if (brand) params.set('brand', brand);
      if (price !== '1000') params.set('price', price);
      if (sort !== 'relevance') params.set('sort', sort);
      window.history.replaceState({}, '', params.toString() ? `?${params}` : '');
    }
    
    function resetAllFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('brandFilter').value = '';
      document.getElementById('priceRange').value = 1000;
      document.getElementById('priceRangeValue').textContent = '1000';
      document.getElementById('sortOptions').value = 'relevance';
      applyFilters('', '', 1000, 'relevance');
    }
    
    // Make functions global
    window.filterProducts = filterProducts;
    window.applyFilters = applyFilters;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('resetAllFilters')?.addEventListener('click', resetAllFilters);
    });
  </script>
</Layout>